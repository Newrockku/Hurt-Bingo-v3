<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin Dashboard - Bingo</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cabin+Condensed:wght@400;700&display=swap" rel="stylesheet">

  <style>
    :root {
      --bg-body: #342e25;
      --bg-card: #494034;
      --bg-well: #342e25;
      --bg-completed: #1e3a1e;
      --bg-completed-well: #162a16;
      --border-main: #6d604e;
      --border-completed: #4caf50;
      --accent: #ffac00;
      --accent-secondary: #c89b3c;
      --text-main: #ffac00;
      --text-bright: #ffee00;
      --text-dim: #858476;
      --text-completed: #4caf50;
      --danger: #ff6d6d;
      --success: #4caf50;
      --warning: #ffcc33;
    }

    * { box-sizing: border-box; }
    html { scrollbar-gutter: stable; overflow-y: scroll; }

    ::-webkit-scrollbar { width: 8px; }
    ::-webkit-scrollbar-track { background: var(--bg-well); }
    ::-webkit-scrollbar-thumb { background: var(--bg-card); border: 2px solid var(--bg-well); }
    ::-webkit-scrollbar-thumb:hover { background: var(--border-main); }

    body {
      background-color: var(--bg-body);
      color: var(--text-main);
      font-family: 'Cabin Condensed', sans-serif;
      margin: 0; padding: 20px;
      display: flex; flex-direction: column; align-items: center;
      min-height: 100vh;
    }

    .admin-header {
      width: 100%; max-width: 1200px;
      background: var(--bg-card); border: 2px solid var(--border-main);
      padding: 20px 30px; margin-bottom: 24px;
      display: flex; justify-content: space-between; align-items: center;
      flex-wrap: wrap; gap: 16px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.4);
    }

    .admin-header-left {
      display: flex; flex-direction: column; gap: 4px;
    }

    .admin-title {
      font-size: 2rem; margin: 0; font-weight: bold;
      color: var(--text-bright); text-transform: uppercase;
      letter-spacing: 2px; text-shadow: 2px 2px 6px rgba(0,0,0,0.6);
    }

    .admin-subtitle {
      font-size: 0.85rem; color: var(--text-dim); margin: 0;
    }

    .admin-header-actions {
      display: flex; gap: 10px; flex-wrap: wrap;
    }

    .admin-btn {
      background: var(--bg-well); border: 2px solid var(--border-main);
      color: var(--text-main); padding: 10px 20px;
      font-family: 'Cabin Condensed', sans-serif; font-size: 0.9rem;
      cursor: pointer; border-radius: 4px; transition: all 0.2s ease;
      text-decoration: none; display: inline-flex; align-items: center; gap: 6px;
      font-weight: bold;
    }

    .admin-btn:hover {
      border-color: var(--accent); color: var(--accent); background: var(--bg-card);
    }

    .admin-btn:focus-visible {
      outline: 2px solid var(--accent); outline-offset: 2px;
    }

    .admin-btn.primary {
      background: var(--accent); border-color: var(--accent);
      color: var(--bg-body); font-weight: bold;
    }

    .admin-btn.primary:hover {
      background: #e09800; border-color: #e09800;
    }

    .admin-btn svg {
      width: 18px; height: 18px; fill: currentColor;
    }

    .dashboard-container {
      width: 100%; max-width: 1200px;
      display: grid; grid-template-columns: 2fr 1fr; gap: 24px;
      padding-bottom: 40px;
    }

    .dashboard-section {
      background: var(--bg-card); border: 2px solid var(--border-main);
      padding: 24px; border-radius: 4px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    }

    .section-title {
      font-size: 1.2rem; font-weight: bold; color: var(--text-bright);
      margin: 0 0 16px 0; text-transform: uppercase; letter-spacing: 1px;
    }

    .stats-grid {
      display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 12px; margin-bottom: 20px;
    }

    .stat-card {
      background: var(--bg-well); border: 1px solid var(--border-main);
      padding: 16px; border-radius: 4px; text-align: center;
    }

    .stat-value {
      font-size: 2rem; font-weight: bold; color: var(--accent);
      margin-bottom: 4px;
    }

    .stat-label {
      font-size: 0.75rem; text-transform: uppercase; color: var(--text-dim);
      letter-spacing: 0.5px;
    }

    .team-list {
      display: flex; flex-direction: column; gap: 12px;
    }

    .team-card {
      background: var(--bg-well); border: 1px solid var(--border-main);
      padding: 16px; border-radius: 4px;
      display: flex; justify-content: space-between; align-items: center;
      gap: 12px; transition: all 0.2s ease;
    }

    .team-card:hover {
      border-color: var(--accent); box-shadow: 0 0 10px rgba(255,172,0,0.2);
    }

    .team-info {
      display: flex; align-items: center; gap: 12px; flex: 1;
    }

    .team-color-badge {
      width: 24px; height: 24px; border-radius: 50%;
      border: 2px solid var(--border-main); flex-shrink: 0;
    }

    .team-details {
      display: flex; flex-direction: column; gap: 2px;
    }

    .team-name {
      font-weight: bold; color: var(--text-bright); font-size: 0.95rem;
    }

    .team-meta {
      font-size: 0.75rem; color: var(--text-dim);
    }

    .team-score {
      font-size: 1.5rem; font-weight: bold; color: var(--accent);
      text-align: right;
    }

    .team-points {
      font-size: 0.7rem; color: var(--text-dim); margin-top: 4px;
    }

    .leaderboard {
      display: flex; flex-direction: column; gap: 12px;
    }

    .leaderboard-entry {
      background: var(--bg-well); border: 1px solid var(--border-main);
      padding: 12px; border-radius: 4px;
      display: grid; grid-template-columns: 30px 1fr auto; gap: 12px; align-items: center;
    }

    .leaderboard-rank {
      font-size: 1.3rem; font-weight: bold; color: var(--accent);
      text-align: center;
    }

    .leaderboard-info {
      display: flex; flex-direction: column; gap: 2px;
    }

    .leaderboard-name {
      color: var(--text-bright); font-weight: bold;
    }

    .leaderboard-detail {
      font-size: 0.75rem; color: var(--text-dim);
    }

    .leaderboard-score {
      font-size: 1.2rem; font-weight: bold; color: var(--success);
    }

    .activity-feed {
      display: flex; flex-direction: column; gap: 10px;
      max-height: 400px; overflow-y: auto;
    }

    .activity-item {
      background: var(--bg-well); border-left: 3px solid var(--accent);
      padding: 12px; border-radius: 2px;
      font-size: 0.85rem; color: var(--text-bright);
    }

    .activity-timestamp {
      font-size: 0.7rem; color: var(--text-dim); margin-top: 4px;
    }

    .page-footer {
      width: 100%; max-width: 1200px;
      padding: 20px 0 10px 0; font-size: 0.7rem;
      color: var(--border-main);
      text-align: center; border-top: 1px solid var(--border-main);
    }

    @media (max-width: 900px) {
      .dashboard-container {
        grid-template-columns: 1fr;
      }

      .admin-header {
        flex-direction: column; align-items: flex-start;
      }

      .admin-title {
        font-size: 1.5rem;
      }

      .stats-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    @media (prefers-reduced-motion: reduce) {
      * { transition: none !important; animation: none !important; }
    }
  </style>
</head>
<body>

  <header class="admin-header">
    <div class="admin-header-left">
      <h1 class="admin-title">üìä Admin Dashboard</h1>
      <p class="admin-subtitle">Real-time overview of the entire bingo event</p>
    </div>
    <div class="admin-header-actions">
      <a href="settings.html" class="admin-btn primary">
        <svg viewBox="0 0 24 24"><path d="M19.14 12.94c.04-.3.06-.61.06-.94 0-.32-.02-.64-.07-.94l2.03-1.58a.49.49 0 00.12-.61l-1.92-3.32a.49.49 0 00-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54a.484.484 0 00-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96a.49.49 0 00-.59.22L2.74 8.87c-.12.21-.08.47.12.61l2.03 1.58c-.05.3-.07.62-.07.94s.02.64.07.94l-2.03 1.58a.49.49 0 00-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.56 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.12-.22.07-.47-.12-.61l-2.01-1.58zM12 15.6A3.6 3.6 0 1115.6 12 3.611 3.611 0 0112 15.6z"/></svg>
        Configure Game
      </a>
      <button class="admin-btn" id="refresh-btn">
        <svg viewBox="0 0 24 24"><path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-8 3.58-8 8s3.58 8 8 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78l-2.58 2.58h6v-6l-2.57 2.57z"/></svg>
        Refresh
      </button>
    </div>
  </header>

  <div class="dashboard-container">
    <!-- LEFT COLUMN: EVENT OVERVIEW & TEAMS -->
    <div>
      <!-- Event Stats -->
      <div class="dashboard-section">
        <h2 class="section-title">üìà Event Overview</h2>
        <div class="stats-grid" id="event-stats-grid">
          <div class="stat-card">
            <div class="stat-value" id="total-teams">0</div>
            <div class="stat-label">Teams</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="total-tiles">0</div>
            <div class="stat-label">Tiles</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="avg-completion">0%</div>
            <div class="stat-label">Avg Completion</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="total-points">0</div>
            <div class="stat-label">Total Points</div>
          </div>
        </div>
      </div>

      <!-- Teams List -->
      <div class="dashboard-section">
        <h2 class="section-title">üë• Team Standings</h2>
        <div class="team-list" id="team-list-container">
          <div style="color:var(--text-dim); font-size:0.85rem; padding:16px; text-align:center;">
            No teams configured. Go to Configure to set up teams.
          </div>
        </div>
      </div>
    </div>

    <!-- RIGHT COLUMN: LEADERBOARD & ACTIVITY -->
    <div>
      <!-- Leaderboard -->
      <div class="dashboard-section">
        <h2 class="section-title">üèÜ Leaderboard</h2>
        <div class="leaderboard" id="leaderboard-container">
          <div style="color:var(--text-dim); font-size:0.85rem; padding:16px; text-align:center;">
            Waiting for data...
          </div>
        </div>
      </div>

      <!-- Activity Feed -->
      <div class="dashboard-section">
        <h2 class="section-title">üìù Recent Activity</h2>
        <div class="activity-feed" id="activity-feed-container">
          <div style="color:var(--text-dim); font-size:0.85rem; padding:16px; text-align:center;">
            No activity yet
          </div>
        </div>
      </div>
    </div>
  </div>

  <footer class="page-footer">
    <p>Bingo Admin Dashboard v1.0 &middot; Real-time Event Monitor</p>
  </footer>

  <script>
(() => {
  const STORAGE_KEYS = {
    eventConfig: 'bingo-event-config',
    teams: 'bingo-teams-config',
    tiles: 'bingo-tiles-config',
    customVars: 'bingo-custom-vars'
  };

  let eventConfig = {};
  let teamsConfig = {};
  let tilesConfig = [];
  let syncIntervalId = null;

  const $ = (id) => document.getElementById(id);
  const DOM = {
    totalTeams: $('total-teams'),
    totalTiles: $('total-tiles'),
    avgCompletion: $('avg-completion'),
    totalPoints: $('total-points'),
    teamListContainer: $('team-list-container'),
    leaderboardContainer: $('leaderboard-container'),
    activityFeedContainer: $('activity-feed-container'),
    refreshBtn: $('refresh-btn')
  };

  /* --- Helpers --- */
  const load = (key) => {
    try { const v = localStorage.getItem(key); return v ? JSON.parse(v) : null; } catch { return null; }
  };

  function loadConfig() {
    eventConfig = load(STORAGE_KEYS.eventConfig) || {};
    teamsConfig = load(STORAGE_KEYS.teams) || {};
    tilesConfig = load(STORAGE_KEYS.tiles) || [];
  }

  function renderEventStats() {
    const teamCount = Object.keys(teamsConfig).length;
    const tileCount = tilesConfig.length;
    const totalTeamPoints = Object.values(teamsConfig).reduce((sum, t) => sum + (parseInt(t.points, 10) || 0), 0);

    DOM.totalTeams.textContent = teamCount;
    DOM.totalTiles.textContent = tileCount;
    DOM.totalPoints.textContent = totalTeamPoints.toLocaleString();

    // Placeholder for average completion (would come from live data)
    DOM.avgCompletion.textContent = '0%';
  }

  function renderTeamStandings() {
    DOM.teamListContainer.innerHTML = '';

    const keys = Object.keys(teamsConfig);
    if (keys.length === 0) {
      DOM.teamListContainer.innerHTML = '<div style="color:var(--text-dim); font-size:0.85rem; padding:16px; text-align:center;">No teams configured.</div>';
      return;
    }

    const frag = document.createDocumentFragment();
    keys.forEach(key => {
      const team = teamsConfig[key];
      const card = document.createElement('div');
      card.className = 'team-card';
      card.innerHTML = `
        <div class="team-info">
          <div class="team-color-badge" style="background:${team.color || '#888'};"></div>
          <div class="team-details">
            <div class="team-name">${escapeHTML(team.name)}</div>
            <div class="team-meta">${escapeHTML(key)} ‚Ä¢ ${team.url ? '‚úì Connected' : '‚úó No Sheet'}</div>
          </div>
        </div>
        <div>
          <div class="team-score">${parseInt(team.points, 10) || 0}</div>
          <div class="team-points">points</div>
        </div>
      `;
      frag.appendChild(card);
    });
    DOM.teamListContainer.appendChild(frag);
  }

  function renderLeaderboard() {
    DOM.leaderboardContainer.innerHTML = '';

    const keys = Object.keys(teamsConfig);
    if (keys.length === 0) {
      DOM.leaderboardContainer.innerHTML = '<div style="color:var(--text-dim); font-size:0.85rem; padding:16px; text-align:center;">No team data.</div>';
      return;
    }

    // Sort by points descending
    const sorted = keys.map(k => ({ key: k, ...teamsConfig[k] }))
      .sort((a, b) => (parseInt(b.points, 10) || 0) - (parseInt(a.points, 10) || 0));

    const frag = document.createDocumentFragment();
    sorted.forEach((team, idx) => {
      const entry = document.createElement('div');
      entry.className = 'leaderboard-entry';
      const medal = idx === 0 ? 'ü•á' : idx === 1 ? 'ü•à' : idx === 2 ? 'ü•â' : `${idx + 1}.`;
      entry.innerHTML = `
        <div class="leaderboard-rank">${medal}</div>
        <div class="leaderboard-info">
          <div class="leaderboard-name">${escapeHTML(team.name)}</div>
          <div class="leaderboard-detail">${escapeHTML(team.key)}</div>
        </div>
        <div class="leaderboard-score">${parseInt(team.points, 10) || 0}</div>
      `;
      frag.appendChild(entry);
    });
    DOM.leaderboardContainer.appendChild(frag);
  }

  function renderActivityFeed() {
    DOM.activityFeedContainer.innerHTML = '';

    const now = new Date();
    const activities = [
      { msg: 'Dashboard initialized', time: now },
      { msg: `${Object.keys(teamsConfig).length} teams configured`, time: new Date(now - 60000) },
      { msg: `${tilesConfig.length} tiles ready`, time: new Date(now - 120000) }
    ];

    const frag = document.createDocumentFragment();
    activities.forEach(act => {
      const item = document.createElement('div');
      item.className = 'activity-item';
      item.innerHTML = `
        <div>${act.msg}</div>
        <div class="activity-timestamp">${act.time.toLocaleTimeString()}</div>
      `;
      frag.appendChild(item);
    });
    DOM.activityFeedContainer.appendChild(frag);
  }

  function escapeHTML(str) {
    const d = document.createElement('div');
    d.appendChild(document.createTextNode(String(str ?? '')));
    return d.innerHTML;
  }

  function updateDashboard() {
    loadConfig();
    renderEventStats();
    renderTeamStandings();
    renderLeaderboard();
    renderActivityFeed();
  }

  function startAutoRefresh() {
    updateDashboard();
    syncIntervalId = setInterval(updateDashboard, 5000);
  }

  function init() {
    startAutoRefresh();
    DOM.refreshBtn.addEventListener('click', () => {
      updateDashboard();
      DOM.refreshBtn.textContent = '‚úì Refreshed';
      setTimeout(() => { DOM.refreshBtn.innerHTML = '<svg viewBox="0 0 24 24"><path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-8 3.58-8 8s3.58 8 8 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78l-2.58 2.58h6v-6l-2.57 2.57z"/></svg> Refresh'; }, 1500);
    });

    // Listen for storage changes from settings.html
    window.addEventListener('storage', (e) => {
      if (e.key && STORAGE_KEYS[Object.keys(STORAGE_KEYS).find(k => STORAGE_KEYS[k] === e.key)]) {
        updateDashboard();
      }
    });
  }

  init();
})();
  </script>
</body>
</html>