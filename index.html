<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Bingo</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cabin+Condensed:wght@400;700&display=swap" rel="stylesheet">

  <!-- Prefer setting CSP in server headers; meta is a fallback. -->
  <meta http-equiv="Content-Security-Policy"
        content="default-src 'self';
                 img-src 'self' https: http: data:;
                 style-src 'self' 'unsafe-inline' https://fonts.googleapis.com;
                 font-src https://fonts.gstatic.com;
                 connect-src https:;
                 script-src 'self' 'unsafe-inline';">

  <style>
    /* --- Theme Variables --- */
    :root {
      --bg-body: #342e25;
      --bg-tile: #494034;
      --bg-well: #342e25;
      --bg-completed: #1e3a1e;
      --bg-completed-well: #162a16;
      --border-main: #6d604e;
      --border-completed: #4caf50;
      --accent: #ffac00;
      --text-main: #ffac00;
      --text-bright: #ffee00;
      --text-dim: #858476;
      --text-completed: #4caf50;
      --danger: #ff6d6d;
    }

    /* --- Seasonal Themes --- */
    [data-theme="spring"] { --bg-body: #2d3a2d; --bg-tile: #4a5d4a; --bg-well: #2d3a2d; --bg-completed: #5d4a5d; --bg-completed-well: #3a2d3a; --border-main: #88b088; --border-completed: #d896ff; --accent: #a2ffb3; --text-main: #a2ffb3; --text-bright: #ffffff; --text-dim: #b5c9b5; --text-completed: #d896ff; }
    [data-theme="summer"] { --bg-body: #1a3a4a; --bg-tile: #2c5d72; --bg-well: #1a3a4a; --bg-completed: #725d2c; --bg-completed-well: #4a3a1a; --border-main: #5ea3cc; --border-completed: #ffcc33; --accent: #33f0ff; --text-main: #33f0ff; --text-bright: #ffffff; --text-dim: #92b7ca; --text-completed: #ffcc33; }
    [data-theme="autumn"] { --bg-body: #3a1f1a; --bg-tile: #5d322c; --bg-well: #3a1f1a; --bg-completed: #2c4a5d; --bg-completed-well: #1a2d3a; --border-main: #a35d4d; --border-completed: #5ea3cc; --accent: #ff7e33; --text-main: #ff7e33; --text-bright: #ffd1b3; --text-dim: #ca9a92; --text-completed: #5ea3cc; }
    [data-theme="winter"] { --bg-body: #1e252b; --bg-tile: #343e49; --bg-well: #1e252b; --bg-completed: #493434; --bg-completed-well: #2b1e1e; --border-main: #6d8ba0; --border-completed: #ff6d6d; --accent: #a0e9ff; --text-main: #a0e9ff; --text-bright: #ffffff; --text-dim: #7e8d9b; --text-completed: #ff6d6d; }

    /* --- Custom Themes --- */
    [data-theme="abyssal"] { --bg-body: #050a14; --bg-tile: #0a192f; --bg-well: #02050a; --bg-completed: #004d4d; --bg-completed-well: #002626; --border-main: #112240; --border-completed: #64ffda; --accent: #64ffda; --text-main: #64ffda; --text-bright: #ccd6f6; --text-dim: #8892b0; --text-completed: #64ffda; }
    [data-theme="volcanic"] { --bg-body: #0f0c0c; --bg-tile: #1a1515; --bg-well: #050404; --bg-completed: #4d1a00; --bg-completed-well: #260d00; --border-main: #3d2b2b; --border-completed: #ff4d00; --accent: #ff4d00; --text-main: #ff4d00; --text-bright: #ffa600; --text-dim: #6d5e5e; --text-completed: #ff4d00; }
    [data-theme="cyberpunk"] { --bg-body: #0d0221; --bg-tile: #261447; --bg-well: #0d0221; --bg-completed: #ff0055; --bg-completed-well: #80002a; --border-main: #fb3640; --border-completed: #00f5d4; --accent: #fee440; --text-main: #ff0055; --text-bright: #ffffff; --text-dim: #9d8189; --text-completed: #00f5d4; }
    [data-theme="bloodlust"] { --bg-body: #1a0505; --bg-tile: #2b0a0a; --bg-well: #120303; --bg-completed: #4d0a0a; --bg-completed-well: #2b0505; --border-main: #4d1515; --border-completed: #ff3333; --accent: #ff3333; --text-main: #cc0000; --text-bright: #ff6666; --text-dim: #664444; --text-completed: #ff3333; }
    [data-theme="royal"] { --bg-body: #1e0d2d; --bg-tile: #3c1b5a; --bg-well: #140820; --bg-completed: #d4af37; --bg-completed-well: #8a6d00; --border-main: #5a3285; --border-completed: #ffee00; --accent: #ffd700; --text-main: #d4af37; --text-bright: #ffffff; --text-dim: #a684c7; --text-completed: #ffee00; }
    [data-theme="emerald"] { --bg-body: #061e12; --bg-tile: #0a3d24; --bg-well: #04120b; --bg-completed: #145a32; --bg-completed-well: #0a3d24; --border-main: #145a32; --border-completed: #2ecc71; --accent: #58d68d; --text-main: #58d68d; --text-bright: #abebc6; --text-dim: #515a5a; --text-completed: #2ecc71; }
    [data-theme="solar"] { --bg-body: #3d2b1f; --bg-tile: #5e412f; --bg-well: #2b1e15; --bg-completed: #f39c12; --bg-completed-well: #af710b; --border-main: #7d5a44; --border-completed: #f1c40f; --accent: #ffcc33; --text-main: #ffcc33; --text-bright: #fff5cc; --text-dim: #a68e7e; --text-completed: #f1c40f; }
    [data-theme="vaporwave"] { --bg-body: #120458; --bg-tile: #240b36; --bg-well: #0b0233; --bg-completed: #ff71ce; --bg-completed-well: #b967ff; --border-main: #05ffa1; --border-completed: #01cdfe; --accent: #01cdfe; --text-main: #b967ff; --text-bright: #ffffff; --text-dim: #7a5c91; --text-completed: #01cdfe; }
    [data-theme="midnight"] { --bg-body: #000000; --bg-tile: #121212; --bg-well: #080808; --bg-completed: #222222; --bg-completed-well: #111111; --border-main: #333333; --border-completed: #ffffff; --accent: #ffffff; --text-main: #eeeeee; --text-bright: #ffffff; --text-dim: #555555; --text-completed: #ffffff; }
    [data-theme="tox"] { --bg-body: #1a001a; --bg-tile: #2d002d; --bg-well: #0f000f; --bg-completed: #1a001a; --bg-completed-well: #0f000f; --border-main: #5e005e; --border-completed: #39ff14; --accent: #dfff11; --text-main: #dfff11; --text-bright: #ffffff; --text-dim: #7a5c7a; --text-completed: #39ff14; }

    * { box-sizing: border-box; }
    html { scrollbar-gutter: stable; overflow-y: scroll; }

    .sr-only {
      position: absolute !important;
      width: 1px; height: 1px;
      padding: 0; margin: -1px;
      overflow: hidden; clip: rect(0, 0, 0, 0);
      border: 0;
      white-space: nowrap;
    }

    ::-webkit-scrollbar { width: 8px; }
    ::-webkit-scrollbar-track { background: var(--bg-well); }
    ::-webkit-scrollbar-thumb { background: var(--bg-tile); border: 2px solid var(--bg-well); }
    ::-webkit-scrollbar-thumb:hover { background: var(--border-main); }

    body {
      background-color: var(--bg-body);
      color: var(--text-main);
      font-family: 'Cabin Condensed', sans-serif;
      margin: 0; padding: 15px;
      display: flex; flex-direction: column; align-items: center; min-height: 100vh;
    }

    .dashboard {
      width: 100%; max-width: 1580px;
      background: var(--bg-tile); border: 2px solid var(--border-main);
      padding: 10px 20px; margin-bottom: 20px;
      display: flex; justify-content: space-between; align-items: center;
      flex-wrap: wrap; gap: 8px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.5); z-index: 100;
    }

    .dashboard-main { display: flex; flex-direction: column; flex: 1; min-width: 0; }
    #event-title { font-size: 1.6rem; margin: 0; text-transform: uppercase; letter-spacing: 1px; text-shadow: 2px 2px 4px black; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    #team-name { font-size: 1.1rem; color: #ffffff; margin: 2px 0 0 0; text-shadow: 1px 1px 2px black; font-weight: bold; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

    .stats-container { display: flex; gap: 15px; align-items: center; flex-shrink: 0; flex-wrap: wrap; }
    .stat-item { text-align: center; }
    .stat-label { font-size: 0.65rem; text-transform: uppercase; color: var(--text-dim); display: block; }
    .stat-value { font-size: 1.3rem; font-weight: bold; color: var(--text-main); }

    #codeword-display {
      cursor: pointer;
      background: var(--bg-well);
      padding: 2px 10px;
      border-radius: 4px;
      min-width: 90px;
      text-align: center;
      display: inline-block;
    }
    .codeword-hidden { color: var(--bg-well); text-shadow: none; }

    .settings-btn {
      background: none; border: 2px solid var(--border-main); color: var(--text-dim);
      width: 38px; height: 38px; border-radius: 4px; cursor: pointer;
      display: flex; justify-content: center; align-items: center;
      transition: all 0.2s ease; flex-shrink: 0; font-size: 1.3rem; padding: 0;
      order: 10;
    }
    .settings-btn:hover { border-color: var(--accent); color: var(--accent); background: var(--bg-well); }
    .settings-btn:focus-visible { outline: 2px solid var(--accent); outline-offset: 2px; }
    .settings-btn svg { width: 20px; height: 20px; fill: currentColor; }

    .minimap-wrapper {
      background: var(--bg-well); padding: 4px; border: 2px solid var(--border-main);
      flex-shrink: 0; cursor: pointer; transition: transform 0.2s ease, border-color 0.2s ease;
    }
    .minimap-wrapper:hover { transform: scale(1.05); border-color: var(--accent); }
    .minimap-wrapper:focus-visible { outline: 2px solid var(--accent); outline-offset: 2px; }
    .minimap-container { display: grid; grid-template-columns: repeat(7, 10px); grid-template-rows: repeat(7, 10px); gap: 2px; pointer-events: none; }
    .mini-tile { width: 10px; height: 10px; background: var(--bg-body); display: flex; justify-content: center; align-items: center; font-size: 7px; color: rgba(255,255,255,0.2); border-radius: 1px; }
    .mini-tile.complete { background: var(--bg-completed); color: var(--text-completed); }

    .grid-container {
      display: grid; grid-template-columns: repeat(7, 1fr); gap: 10px;
      width: 100%; max-width: 1580px;
    }

    .tile {
      background-color: var(--bg-tile);
      border: 2px solid var(--border-main);
      position: relative;
      aspect-ratio: 1 / 1;
      display: flex; flex-direction: column;
      padding: 5%;
      box-shadow: inset 0 0 10px rgba(0,0,0,0.5);
      overflow: hidden;
      container-type: inline-size;
      cursor: pointer;
      transition: all 0.3s ease, opacity 0.4s ease;
    }
    .tile.completed { background-color: var(--bg-completed); border-color: var(--border-completed); }

    .tile:hover {
      transform: scale(1.05);
      z-index: 50;
      box-shadow: 0 0 25px 2px var(--accent), inset 0 0 10px rgba(0, 0, 0, 0.5);
    }
    .tile.completed:hover {
      box-shadow: 0 0 25px 2px var(--border-completed), inset 0 0 10px rgba(0, 0, 0, 0.5);
    }

    .tile:focus-visible {
      outline: 3px solid var(--accent);
      outline-offset: 2px;
      transform: scale(1.02);
      z-index: 60;
    }
    .tile.completed:focus-visible { outline-color: var(--border-completed); }

    .tile.ghost { opacity: 0; pointer-events: none; }

    .header-box { padding: 2% 0; margin-bottom: 2%; min-height: 18%; display: flex; justify-content: center; align-items: center; flex-shrink: 0; overflow: hidden; text-align: center; }
    .header-content { width: 100%; font-weight: bold; font-size: 8cqw; line-height: 1; white-space: nowrap; text-shadow: 1px 1px 2px black; color: var(--text-main); }
    .tile.completed .header-content { color: var(--text-completed); }

    .img-container { height: 40%; display: flex; justify-content: center; align-items: center; margin-bottom: 2%; flex-shrink: 0; }
    .img-container img { max-height: 100%; max-width: 95%; object-fit: contain; filter: drop-shadow(2px 3px 4px black); }

    .progress-container { margin-bottom: 2%; height: 2cqw; min-height: 5px; width: 100%; flex-shrink: 0; }
    .tile.completed .progress-container { display: none; }
    .progress-bg { background: var(--bg-well); height: 100%; border: 1px solid #000; width: 100%; overflow: hidden; }
    .progress-fill { height: 100%; transition: width 0.5s ease, background-color 0.5s ease; }

    .checklist-box { background: var(--bg-well); border: 1px solid #000; padding: 3%; flex-grow: 1; width: 100%; overflow-y: auto; min-height: 0; transition: background 0.3s ease; position: relative; }
    .tile.completed .checklist-box { background: var(--bg-completed-well); }
    .tile.completed .checklist-box::-webkit-scrollbar-track { background: var(--bg-completed); }
    .tile.completed .checklist-box::-webkit-scrollbar-thumb { background: var(--bg-completed-well); border: 2px solid var(--bg-completed); }

    .check-item { display: flex; align-items: center; margin-bottom: 4px; }
    .check-mark { width: 1.2em; height: 1.2em; margin-right: 6px; flex-shrink: 0; position: relative; display: flex; justify-content: center; align-items: center; }
    .check-mark::after { content: ''; width: 0.3em; height: 0.6em; border: solid var(--text-completed); border-width: 0 0.2em 0.2em 0; transform: rotate(45deg); }
    .tile .check-item { font-size: 6cqw; color: var(--text-bright); }
    .tile.completed .check-item { color: var(--text-completed); }

    .point-badge {
      position: absolute; bottom: 5px; right: 5px; background: var(--bg-well);
      border: 1px solid var(--accent); padding: 1px 5px; border-radius: 3px;
      font-size: 10px; font-weight: bold; color: var(--text-main); z-index: 10;
    }
    .tile.completed .point-badge { border-color: var(--border-completed); color: var(--text-completed); background: var(--bg-completed-well); }

    .tile.no-data { opacity: 0.55; cursor: default; }
    .tile.no-data:hover { transform: none; box-shadow: inset 0 0 10px rgba(0,0,0,0.5); z-index: auto; }
    .tile.no-data:focus-visible { outline: none; transform: none; }

    #modal-overlay {
      position: fixed; top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0, 0, 0, 0);
      display: none;
      justify-content: center; align-items: center;
      z-index: 2000;
      backdrop-filter: blur(0px);
      transition: background 0.4s ease, backdrop-filter 0.4s ease;
    }
    #modal-overlay.active { background: rgba(0, 0, 0, 0.75); backdrop-filter: blur(5px); }

    .modal-content {
      background-color: var(--bg-tile); border: 3px solid var(--border-main);
      width: 90vw; max-width: 450px;
      padding: 25px;
      position: fixed;
      box-shadow: 0 0 50px rgba(0, 0, 0, 0.8);
      display: flex; flex-direction: column;
      opacity: 0;
      transform: translate(-50%, -50%) scale(0);
      transition: all 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
      pointer-events: none;
      z-index: 2001;
    }
    .modal-content.completed { background-color: var(--bg-completed); border-color: var(--border-completed); }
    .modal-content.active { opacity: 1; top: 50% !important; left: 50% !important; transform: translate(-50%, -50%) scale(1); pointer-events: auto; }

    .modal-header { font-size: 1.8rem; margin-bottom: 12px; text-align: center; font-weight: bold; color: var(--text-main); text-shadow: 2px 2px 4px rgba(0,0,0,0.8); }
    .modal-content.completed .modal-header { color: var(--text-completed); }

    .modal-img { height: 120px; margin-bottom: 12px; display: flex; justify-content: center; }
    .modal-img img { max-height: 100%; filter: drop-shadow(4px 4px 6px black); }

    .modal-label { font-size: 0.7rem; text-transform: uppercase; font-weight: bold; margin-bottom: 2px; color: var(--text-main); }
    .modal-content.completed .modal-label { color: var(--text-completed); }

    .modal-points-inline { font-size: 0.85rem; background: var(--bg-well); border: 1px solid var(--accent); padding: 1px 6px; border-radius: 4px; font-weight: bold; color: var(--text-main); }
    .modal-content.completed .modal-points-inline { border-color: var(--border-completed); color: var(--text-completed); background: var(--bg-completed-well); }

    .modal-checklist, .modal-description { background: var(--bg-well); border: 1px solid #000; padding: 8px; overflow-y: auto; color: var(--text-bright); }
    .modal-content.completed .modal-checklist, .modal-content.completed .modal-description { background: var(--bg-completed-well); color: var(--text-completed); }

    .modal-top-bar {
      display: flex; justify-content: space-between; align-items: center;
      margin-bottom: 0; min-height: 30px;
    }
    .modal-map-btn {
      background: none; border: none; padding: 4px; cursor: pointer;
      color: var(--text-dim); display: flex; align-items: center; justify-content: center;
      border-radius: 4px; transition: all 0.2s ease;
    }
    .modal-map-btn:hover { color: var(--accent); background: var(--bg-well); }
    .modal-map-btn:focus-visible { outline: 2px solid var(--accent); outline-offset: 2px; }
    .modal-map-btn svg { width: 22px; height: 22px; fill: currentColor; }

    .modal-close-btn {
      background: none; border: none; padding: 4px; cursor: pointer;
      color: var(--text-dim); display: flex; align-items: center; justify-content: center;
      font-size: 2rem; line-height: 1; transition: all 0.2s ease; border-radius: 4px;
    }
    .modal-close-btn:hover { color: var(--accent); background: var(--bg-well); }
    .modal-close-btn:focus-visible { outline: 2px solid var(--accent); outline-offset: 2px; }

    .large-map-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; background: var(--bg-body); padding: 10px; border: 2px solid var(--border-main); width: 100%; aspect-ratio: 1/1; }
    .large-map-tile { background: var(--bg-well); display: flex; justify-content: center; align-items: center; font-size: 1.2rem; font-weight: bold; color: rgba(255,255,255,0.2); border: 1px solid var(--bg-tile); cursor: pointer; transition: 0.2s; }
    .large-map-tile:hover { background: var(--bg-tile); color: #fff; transform: scale(1.05); z-index: 2; border-color: var(--accent); }
    .large-map-tile.complete { background: var(--bg-completed); color: var(--text-completed); border-color: var(--border-completed); }
    .large-map-tile:focus-visible { outline: 2px solid var(--accent); outline-offset: 2px; }

    .settings-section { margin-bottom: 18px; }
    .settings-section-title {
      font-size: 0.75rem; text-transform: uppercase; font-weight: bold;
      color: var(--text-dim); letter-spacing: 1px; margin-bottom: 8px;
      padding-bottom: 4px; border-bottom: 1px solid var(--border-main);
    }
    .settings-row { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; }
    .settings-row-label { font-size: 1rem; color: var(--text-bright); }
    .settings-row-hint { font-size: 0.7rem; color: var(--text-dim); margin-top: 2px; }
    .settings-select {
      background: var(--bg-well); color: var(--text-main); border: 1px solid var(--border-main);
      padding: 5px 10px; font-family: 'Cabin Condensed'; cursor: pointer;
      font-size: 1rem; border-radius: 4px; min-width: 140px;
    }
    .settings-select:focus { border-color: var(--accent); outline: none; }
    .settings-version { text-align: center; font-size: 0.7rem; color: var(--text-dim); margin-top: 10px; padding-top: 10px; border-top: 1px solid var(--border-main); }

    .page-footer {
      width: 100%; max-width: 1580px;
      padding: 15px 0 10px 0;
      font-size: 0.65rem; color: var(--border-main);
      display: flex; align-items: center; gap: 6px;
      flex-wrap: wrap;
    }
    .sync-btn { cursor: pointer; color: var(--text-dim); text-decoration: underline; }
    .sync-btn:hover { color: var(--accent); }
    .sync-flash { animation: flash-sync 1s ease-out; }
    @keyframes flash-sync { 0% { color: var(--accent); } 100% { color: var(--border-main); } }
    .sync-error { color: var(--danger); }

    @media (max-width: 1400px) {
      .grid-container { grid-template-columns: repeat(5, 1fr); }
      .minimap-wrapper.in-dashboard { display: none; }
      .minimap-wrapper.floating {
        display: block; position: fixed; bottom: 20px; right: 20px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.7); background: var(--bg-well);
        border: 2px solid var(--border-main); z-index: 1000;
      }
      .minimap-wrapper.floating .minimap-container { grid-template-columns: repeat(7, 12px); grid-template-rows: repeat(7, 12px); }
      .minimap-wrapper.floating .mini-tile { width: 12px; height: 12px; font-size: 7px; }
    }
    @media (min-width: 1401px) { .minimap-wrapper.floating { display: none; } }
    @media (max-width: 1000px) { .grid-container { grid-template-columns: repeat(4, 1fr); } }

    @media (max-width: 768px) {
      body { padding: 8px; }
      .dashboard { padding: 8px 12px; gap: 6px; }
      .dashboard-main { flex-basis: calc(100% - 50px); }
      #event-title { font-size: 1.2rem; }
      #team-name { font-size: 0.9rem; }
      .stats-container {
        order: 3; flex-basis: 100%; justify-content: center;
        gap: 12px; padding-top: 6px;
        border-top: 1px solid var(--border-main);
      }
      .stat-value { font-size: 1.1rem; }
      #codeword-display { min-width: 70px; padding: 2px 8px; }
      .settings-btn { order: 2; }
    }

    @media (max-width: 600px) {
      .grid-container { grid-template-columns: repeat(3, 1fr); }
      .dashboard { padding: 6px 10px; }
      #event-title { font-size: 1rem; }
      #team-name { font-size: 0.8rem; }
      .stats-container { gap: 10px; }
      .stat-label { font-size: 0.6rem; }
      .stat-value { font-size: 1rem; }
    }

    @media (prefers-reduced-motion: reduce) {
      * { transition: none !important; animation: none !important; scroll-behavior: auto !important; }
      .tile:hover { transform: none !important; }
      .minimap-wrapper:hover { transform: none !important; }
    }
  </style>
</head>

<body>
  <header class="dashboard" role="banner">
    <div class="dashboard-main">
      <h1 id="event-title">Bingo 2026</h1>
      <p id="team-name">Loading Team...</p>
    </div>

    <div class="stats-container">
      <div class="stat-item">
        <span class="stat-label">Codeword</span>
        <span id="codeword-display"
              class="stat-value codeword-hidden"
              role="button" tabindex="0"
              aria-label="Codeword hidden. Click to reveal.">?????</span>
      </div>

      <div class="stat-item">
        <span class="stat-label">Points</span>
        <span id="total-points" class="stat-value" aria-live="polite">0</span>
      </div>

      <div class="stat-item">
        <span class="stat-label">Completed</span>
        <span id="completed-count" class="stat-value" aria-live="polite">0/49</span>
      </div>
    </div>

    <aside class="minimap-wrapper in-dashboard" id="mini-map-trigger"
           role="button" tabindex="0" aria-label="Open overview map">
      <div class="minimap-container" id="minimap" aria-hidden="true"></div>
    </aside>

    <button class="settings-btn" id="settings-trigger" aria-label="Open settings">
      <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
        <path d="M19.14 12.94c.04-.3.06-.61.06-.94 0-.32-.02-.64-.07-.94l2.03-1.58a.49.49 0 00.12-.61l-1.92-3.32a.49.49 0 00-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54a.484.484 0 00-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96a.49.49 0 00-.59.22L2.74 8.87c-.12.21-.08.47.12.61l2.03 1.58c-.05.3-.07.62-.07.94s.02.64.07.94l-2.03 1.58a.49.49 0 00-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.56 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.12-.22.07-.47-.12-.61l-2.01-1.58zM12 15.6A3.6 3.6 0 1115.6 12 3.611 3.611 0 0112 15.6z"/>
      </svg>
    </button>
  </header>

  <aside class="minimap-wrapper floating" id="mini-map-floating"
         role="button" tabindex="0" aria-label="Open overview map">
    <div class="minimap-container" id="minimap-floating" aria-hidden="true"></div>
  </aside>

  <main class="grid-container" id="grid" role="grid" aria-label="Bingo board"></main>

  <footer class="page-footer">
    <span>v3.083</span>
    <span>&middot;</span>
    <span id="last-sync-text" aria-live="polite">Last Sync: Never</span>
    <span class="sync-btn" id="sync-now" role="button" tabindex="0">[Sync Now]</span>
  </footer>

  <div id="modal-overlay" role="dialog" aria-modal="true" aria-label="Dialog">
    <div class="modal-content" id="modal-box" aria-label="Dialog panel">
      <!-- Standard Tile View -->
      <div id="standard-modal-view">
        <div class="modal-top-bar">
          <button class="modal-map-btn" id="modal-map-back" aria-label="Back to overview map" tabindex="0">
            <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M3 3h8v8H3V3zm10 0h8v8h-8V3zM3 13h8v8H3v-8zm10 0h8v8h-8v-8z"/></svg>
          </button>
          <button class="modal-close-btn" id="modal-close-1" aria-label="Close dialog" tabindex="0">&times;</button>
        </div>

        <div id="modal-header" class="modal-header"></div>
        <div class="modal-img"><img id="modal-image" src="" alt=""></div>

        <div id="modal-progress-section">
          <div class="modal-label">Progress</div>
          <div style="height: 12px; margin-bottom: 12px;">
            <div class="progress-bg"><div id="modal-bar" class="progress-fill"></div></div>
          </div>
        </div>

        <div style="display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 2px;">
          <div class="modal-label">Collected Items</div>
          <div id="modal-points" class="modal-points-inline">0 PTS</div>
        </div>
        <div id="modal-list" class="modal-checklist" style="max-height: 130px; margin-bottom: 12px;"></div>

        <div class="modal-label">Description</div>
        <div id="modal-desc" class="modal-description" style="max-height: 80px;"></div>
      </div>

      <!-- Map Overview View -->
      <div id="map-modal-view" style="display: none; flex-direction: column; align-items: center;">
        <div class="modal-top-bar" style="width: 100%;">
          <div></div>
          <button class="modal-close-btn" id="modal-close-2" aria-label="Close dialog" tabindex="0">&times;</button>
        </div>
        <div class="modal-header" style="margin-top: 0;">OVERVIEW</div>
        <div class="large-map-grid" id="large-map-grid"></div>
      </div>

      <!-- Settings View -->
      <div id="settings-modal-view" style="display: none; flex-direction: column;">
        <div class="modal-top-bar">
          <div></div>
          <button class="modal-close-btn" id="modal-close-3" aria-label="Close dialog" tabindex="0">&times;</button>
        </div>
        <div class="modal-header" style="margin-top: 0;">SETTINGS</div>

        <div class="settings-section">
          <div class="settings-section-title">Appearance</div>
          <div class="settings-row">
            <div>
              <div class="settings-row-label">Theme</div>
              <div class="settings-row-hint">Choose a visual style</div>
            </div>
            <label for="settings-theme-dropdown" class="sr-only">Select Theme</label>
            <select id="settings-theme-dropdown" class="settings-select">
              <optgroup label="Classic">
                <option value="osrs">OSRS (Original)</option>
                <option value="midnight">Midnight OLED</option>
              </optgroup>
              <optgroup label="Seasons">
                <option value="spring">Spring</option>
                <option value="summer">Summer</option>
                <option value="autumn">Autumn</option>
                <option value="winter">Winter</option>
              </optgroup>
              <optgroup label="Aesthetic">
                <option value="abyssal">Abyssal</option>
                <option value="volcanic">Volcanic</option>
                <option value="cyberpunk">Cyberpunk</option>
                <option value="bloodlust">Bloodlust</option>
                <option value="royal">Royal</option>
                <option value="emerald">Emerald</option>
                <option value="solar">Solar</option>
                <option value="vaporwave">Vaporwave</option>
                <option value="tox">Toxic</option>
              </optgroup>
            </select>
          </div>
        </div>

        <div class="settings-section">
          <div class="settings-section-title">Data</div>
          <div class="settings-row">
            <div>
              <div class="settings-row-label">Sync Interval</div>
              <div class="settings-row-hint">How often to refresh data</div>
            </div>
            <select id="settings-sync-interval" class="settings-select">
              <option value="15000">15 seconds</option>
              <option value="30000" selected>30 seconds</option>
              <option value="60000">1 minute</option>
              <option value="120000">2 minutes</option>
              <option value="300000">5 minutes</option>
            </select>
          </div>
        </div>

        <div class="settings-version">Bingo Board &middot; v3.083</div>
      </div>
    </div>
  </div>

<script>
(() => {
  /* =========================
     CONFIG / STATE
     ========================= */
  const APP_VERSION = '3.083';
  const MAX_TILES = 49;

  const TEAM_MAP = {
    Warriors: {
      name: "The Spreadsheet Warriors",
      url: "https://docs.google.com/spreadsheets/d/e/2PACX-1vRFOGe_j8BL0X5Cwvy3LNmsrWG82IAXlWpump0Sw6PKWLz-1gxbisdbPuTmJ_CmjLA_q-Q6y9jTfFwq/pub?gid=1593254680&single=true&output=csv",
      codeword: "BINGO_BLITZ",
      points: 1250
    }
  };

  const STORAGE_KEYS = {
    theme: 'bingo-theme',
    syncInterval: 'bingo-sync-interval',
    codewordVisible: 'bingo-codeword-visible'
  };

  let currentTeamKey = 'Warriors';
  let codewordSecret = '';
  let lastSeenHash = null;

  let completion = Array(MAX_TILES).fill(false);
  let tiles = Array(MAX_TILES).fill(null);

  let fetchController = null;
  let syncIntervalId = null;
  let syncMs = 30000;

  let modalOpen = false;
  let lastTriggerEl = null;
  let ghostEl = null;

  /* =========================
     DOM HELPERS
     ========================= */
  const $ = (id) => document.getElementById(id);

  const DOM = {
    teamName: $('team-name'),
    totalPoints: $('total-points'),
    completedCount: $('completed-count'),
    codeword: $('codeword-display'),
    grid: $('grid'),
    lastSync: $('last-sync-text'),
    syncNow: $('sync-now'),
    settingsTrigger: $('settings-trigger'),
    miniDash: $('mini-map-trigger'),
    miniFloat: $('mini-map-floating'),

    overlay: $('modal-overlay'),
    box: $('modal-box'),

    viewStd: $('standard-modal-view'),
    viewMap: $('map-modal-view'),
    viewSettings: $('settings-modal-view'),

    modalHeader: $('modal-header'),
    modalImage: $('modal-image'),
    modalProgressSection: $('modal-progress-section'),
    modalBar: $('modal-bar'),
    modalList: $('modal-list'),
    modalDesc: $('modal-desc'),
    modalPoints: $('modal-points'),

    mapBack: $('modal-map-back'),
    bigMap: $('large-map-grid'),

    themeSel: $('settings-theme-dropdown'),
    intervalSel: $('settings-sync-interval'),
  };

  // Minimaps: index 1..49 => [node,node]
  const miniNodes = Array.from({ length: MAX_TILES + 1 }, () => []);

  /* =========================
     SMALL UTILS
     ========================= */
  const storageSave = (k, v) => { try { localStorage.setItem(k, String(v)); } catch {} };
  const storageLoad = (k, fb) => { try { const v = localStorage.getItem(k); return v ?? fb; } catch { return fb; } };

  const normalizeNL = (s) => String(s).replace(/\r\n/g, '\n').replace(/\r/g, '\n');

  const simpleHash = (str) => {
    let h = 0;
    for (let i = 0; i < str.length; i++) { h = ((h << 5) - h) + str.charCodeAt(i); h |= 0; }
    return h;
  };

  const escapeHTML = (str) => {
    const d = document.createElement('div');
    d.appendChild(document.createTextNode(String(str ?? '')));
    return d.innerHTML;
  };

  const parseCSVRow = (row) => {
    const cols = [];
    let cur = '', inQ = false;
    for (let i = 0; i < row.length; i++) {
      const ch = row[i];
      if (inQ) {
        if (ch === '"' && row[i + 1] === '"') { cur += '"'; i++; }
        else if (ch === '"') inQ = false;
        else cur += ch;
      } else {
        if (ch === '"') inQ = true;
        else if (ch === ',') { cols.push(cur.trim()); cur = ''; }
        else cur += ch;
      }
    }
    cols.push(cur.trim());
    return cols;
  };

  const getProgressColor = (pct) => {
    if (pct >= 100) return 'var(--text-completed)';
    const hue = (pct * 120) / 100;
    return `hsl(${hue}, 70%, 45%)`;
  };

  const handleImgError = (img) => {
    img.style.visibility = 'hidden';
    img.removeAttribute('src');
  };

  // FIX: supports spaces/apostrophes by URL-encoding, blocks traversal
  const safeImgSrc = (imgName) => {
    const raw = String(imgName || '').trim();
    if (!raw) return '';
    if (/^https?:\/\//i.test(raw)) return raw;

    const parts = raw.replace(/\\/g, '/')
      .split('/')
      .filter(Boolean)
      .filter(p => p !== '.' && p !== '..');

    return `./images/${parts.map(encodeURIComponent).join('/')}`;
  };

  const applyTheme = (theme) => {
    if (!theme || theme === 'osrs') document.documentElement.removeAttribute('data-theme');
    else document.documentElement.setAttribute('data-theme', theme);
  };

  const hideViews = () => {
    DOM.viewStd.style.display = 'none';
    DOM.viewMap.style.display = 'none';
    DOM.viewSettings.style.display = 'none';
  };

  const setMinimapComplete = (id1, done) => {
    for (const n of miniNodes[id1]) n.classList.toggle('complete', !!done);
  };

  const resetMinimaps = () => {
    for (let i = 1; i <= MAX_TILES; i++) setMinimapComplete(i, false);
  };

  const updateCompletedStat = () => {
    const done = completion.reduce((a, v) => a + (v ? 1 : 0), 0);
    DOM.completedCount.innerText = `${done}/${MAX_TILES}`;
  };

  const flashSync = () => {
    DOM.lastSync.classList.remove('sync-error');
    DOM.lastSync.innerText = `Last Sync: ${new Date().toLocaleTimeString()}`;
    DOM.lastSync.classList.remove('sync-flash');
    void DOM.lastSync.offsetWidth;
    DOM.lastSync.classList.add('sync-flash');
  };

  const syncError = (msg) => {
    DOM.lastSync.classList.add('sync-error');
    DOM.lastSync.innerText = `Sync failed: ${msg}`;
  };

  /* =========================
     MINIMAP BUILD
     ========================= */
  const buildMinimap = (containerId) => {
    const el = $(containerId);
    if (!el) return;
    el.innerHTML = '';

    const frag = document.createDocumentFragment();
    for (let i = 1; i <= MAX_TILES; i++) {
      const d = document.createElement('div');
      d.className = 'mini-tile';
      d.dataset.index = String(i);
      d.innerText = String(i);
      frag.appendChild(d);
      miniNodes[i].push(d);
    }
    el.appendChild(frag);
  };

  /* =========================
     RENDER
     ========================= */
  const renderGrid = () => {
    DOM.grid.innerHTML = '';
    const frag = document.createDocumentFragment();

    for (let i = 0; i < MAX_TILES; i++) {
      const t = tiles[i];
      const done = !!t.isCompleted;

      const tile = document.createElement('div');
      tile.className = `tile${done ? ' completed' : ''}${t.noData ? ' no-data' : ''}`;
      tile.dataset.tileIndex = String(i);
      tile.setAttribute('role', 'button');
      tile.tabIndex = t.noData ? -1 : 0;
      tile.setAttribute('aria-label',
        t.noData
          ? `Tile ${t.id}: No data`
          : `Tile ${t.id}: ${t.title} - ${done ? 'Complete' : Math.round(t.percent) + '% complete'}`
      );

      const safeTitle = escapeHTML(t.title);
      const safePts = escapeHTML(t.points);

      tile.innerHTML = `
        <div class="header-box"><div class="header-content">${t.id} | ${safeTitle}</div></div>
        <div class="img-container"><img alt="${safeTitle}"></div>
        <div class="progress-container"><div class="progress-bg"><div class="progress-fill"></div></div></div>
        <div class="checklist-box">${t.checklistHtml /* blank allowed */}</div>
        <div class="point-badge">${safePts} PTS</div>
      `;

      const img = tile.querySelector('img');
      if (t.img) {
        img.style.visibility = 'visible';
        img.addEventListener('error', () => handleImgError(img), { once: true });
        img.src = t.img;
      } else {
        handleImgError(img);
      }

      const fill = tile.querySelector('.progress-fill');
      fill.style.width = t.percent + '%';
      fill.style.backgroundColor = t.barColor;

      if (done) tile.querySelector('.progress-container')?.style && (tile.querySelector('.progress-container').style.display = 'none');

      frag.appendChild(tile);
    }

    DOM.grid.appendChild(frag);
  };

  const buildBigMap = () => {
    DOM.bigMap.innerHTML = '';
    const frag = document.createDocumentFragment();

    for (let i = 1; i <= MAX_TILES; i++) {
      const cell = document.createElement('div');
      cell.className = `large-map-tile${completion[i - 1] ? ' complete' : ''}`;
      cell.dataset.index = String(i);
      cell.innerText = String(i);
      cell.tabIndex = 0;
      cell.setAttribute('role', 'button');
      frag.appendChild(cell);
    }
    DOM.bigMap.appendChild(frag);
  };

  /* =========================
     MODAL
     ========================= */
  const showModal = (triggerEl, animate = true) => {
    if (ghostEl?.isConnected) ghostEl.classList.remove('ghost');
    lastTriggerEl = triggerEl || lastTriggerEl;
    ghostEl = triggerEl;

    if (ghostEl?.classList?.contains('tile') || ghostEl?.id === 'mini-map-trigger' || ghostEl?.id === 'mini-map-floating') {
      ghostEl.classList.add('ghost');
    }

    const rect = (animate && triggerEl?.getBoundingClientRect)
      ? triggerEl.getBoundingClientRect()
      : { top: innerHeight / 2, left: innerWidth / 2, height: 0, width: 0 };

    DOM.box.style.top = (rect.top + rect.height / 2) + 'px';
    DOM.box.style.left = (rect.left + rect.width / 2) + 'px';

    DOM.overlay.style.display = 'flex';
    setTimeout(() => {
      DOM.overlay.classList.add('active');
      DOM.box.classList.add('active');
      modalOpen = true;
      DOM.box.querySelector('.modal-close-btn')?.focus();
    }, 10);

    document.body.style.overflow = 'hidden';
  };

  const closeModal = () => {
    DOM.overlay.classList.remove('active');
    DOM.box.classList.remove('active');
    modalOpen = false;

    if (ghostEl?.isConnected) ghostEl.classList.remove('ghost');

    setTimeout(() => {
      DOM.overlay.style.display = 'none';
      document.body.style.overflow = 'auto';
      lastTriggerEl?.focus?.();
    }, 500);
  };

  const openTileModalByIndex = (tileIndex, triggerEl) => {
    const t = tiles[tileIndex];
    if (!t || t.noData) return;

    DOM.box.classList.toggle('completed', !!t.isCompleted);

    hideViews();
    DOM.viewStd.style.display = 'block';

    DOM.modalHeader.innerText = `${t.id} | ${t.title}`;
    DOM.modalPoints.innerText = `${t.points} PTS`;

    DOM.modalProgressSection.style.display = t.isCompleted ? 'none' : 'block';
    DOM.modalBar.style.width = t.percent + '%';
    DOM.modalBar.style.backgroundColor = t.barColor;

    DOM.modalList.innerHTML = t.checklistHtml; // blank allowed
    DOM.modalDesc.innerText = t.description || '';

    DOM.modalImage.src = '';
    DOM.modalImage.onerror = null;
    DOM.modalImage.style.visibility = 'visible';
    DOM.modalImage.alt = t.title;

    if (t.img) {
      DOM.modalImage.onerror = () => handleImgError(DOM.modalImage);
      DOM.modalImage.src = t.img;
    } else {
      handleImgError(DOM.modalImage);
    }

    showModal(triggerEl, true);
  };

  const openMapModal = (triggerEl) => {
    DOM.box.classList.remove('completed');
    hideViews();
    DOM.viewMap.style.display = 'flex';
    buildBigMap();
    showModal(triggerEl, true);
  };

  const openSettingsModal = (triggerEl) => {
    DOM.box.classList.remove('completed');
    hideViews();
    DOM.viewSettings.style.display = 'flex';

    const theme = document.documentElement.getAttribute('data-theme') || 'osrs';
    DOM.themeSel.value = theme;
    DOM.intervalSel.value = String(syncMs);

    showModal(triggerEl, true);
  };

  /* =========================
     CODEWORD
     ========================= */
  const setCodewordVisible = (visible) => {
    DOM.codeword.classList.toggle('codeword-hidden', !visible);
    DOM.codeword.innerText = visible ? (codewordSecret || '') : '?????';
    DOM.codeword.setAttribute('aria-label',
      visible ? `Codeword: ${codewordSecret}. Click to hide.` : 'Codeword hidden. Click to reveal.'
    );
    storageSave(STORAGE_KEYS.codewordVisible, visible ? '1' : '0');
  };

  const toggleCodeword = () => {
    setCodewordVisible(DOM.codeword.classList.contains('codeword-hidden'));
  };

  /* =========================
     FETCH / PARSE
     ========================= */
  const fetchGlobal = () => {
    const t = TEAM_MAP[currentTeamKey];
    DOM.teamName.innerText = t.name;
    DOM.totalPoints.innerText = Number(t.points || 0).toLocaleString();
    codewordSecret = t.codeword || '';
  };

  async function fetchData(manual = false) {
    if (fetchController) fetchController.abort();
    fetchController = new AbortController();

    try {
      const team = TEAM_MAP[currentTeamKey];
      const res = await fetch(`${team.url}&t=${Date.now()}`, {
        headers: { 'pragma': 'no-cache', 'cache-control': 'no-cache' },
        signal: fetchController.signal
      });

      const raw = normalizeNL(await res.text());
      const h = simpleHash(raw);
      if (!manual && lastSeenHash === h) return;
      lastSeenHash = h;

      flashSync();

      completion = Array(MAX_TILES).fill(false);
      tiles = Array(MAX_TILES).fill(null);
      resetMinimaps();

      const rows = raw.split('\n').slice(1);
      let count = 0;

      for (const line of rows) {
        if (count >= MAX_TILES) break;
        if (!line || !line.trim()) continue;

        const cols = parseCSVRow(line.trim());
        if (cols.length < 4) continue;

        const id = count + 1;
        const title = cols[0] || `Tile ${id}`;
        const img = safeImgSrc(cols[1] || '');
        const current = Math.max(0, parseInt(cols[2], 10) || 0);
        const goal = Math.max(1, parseInt(cols[3], 10) || 1);
        const items = cols[4] ? cols[4].split(',').map(s => s.trim()).filter(Boolean) : [];
        const description = cols[5] || '';
        const points = cols[6] || '0';

        const percent = Math.min((current / goal) * 100, 100);
        const isCompleted = percent === 100;

        completion[count] = isCompleted;
        setMinimapComplete(id, isCompleted);

        // CHANGE: if no items, checklistHtml stays '' (blank)
        const checklistHtml = items.map(it =>
          `<div class="check-item"><span class="check-mark"></span> ${escapeHTML(it)}</div>`
        ).join('');

        tiles[count] = {
          id, title, img,
          percent, barColor: getProgressColor(percent),
          checklistHtml, description,
          isCompleted, points,
          noData: false
        };

        count++;
      }

      for (let i = 0; i < MAX_TILES; i++) {
        if (!tiles[i]) {
          tiles[i] = {
            id: i + 1,
            title: 'No Data',
            img: '',
            percent: 0,
            barColor: getProgressColor(0),
            checklistHtml: '',
            description: '',
            isCompleted: false,
            points: '0',
            noData: true
          };
        }
      }

      renderGrid();
      updateCompletedStat();
    } catch (e) {
      if (e.name !== 'AbortError') {
        console.error(e);
        syncError('Network error');
      }
    } finally {
      fetchController = null;
    }
  }

  /* =========================
     EVENTS (condensed)
     ========================= */
  function trapFocus(e) {
    if (!modalOpen || e.key !== 'Tab') return;
    const focusable = [...DOM.box.querySelectorAll('button,select,[tabindex]:not([tabindex="-1"])')]
      .filter(el => !el.disabled && el.offsetParent !== null);
    if (!focusable.length) return;
    const first = focusable[0], last = focusable[focusable.length - 1];

    if (e.shiftKey && document.activeElement === first) { e.preventDefault(); last.focus(); }
    else if (!e.shiftKey && document.activeElement === last) { e.preventDefault(); first.focus(); }
  }

  function restartInterval() {
    if (syncIntervalId) clearInterval(syncIntervalId);
    syncIntervalId = setInterval(() => fetchData(false), syncMs);
  }

  function init() {
    // theme
    const savedTheme = storageLoad(STORAGE_KEYS.theme, 'osrs');
    applyTheme(savedTheme);
    DOM.themeSel.value = savedTheme;

    // interval
    syncMs = parseInt(storageLoad(STORAGE_KEYS.syncInterval, '30000'), 10) || 30000;
    DOM.intervalSel.value = String(syncMs);

    // minimaps
    miniNodes.forEach(arr => arr.length = 0);
    buildMinimap('minimap');
    buildMinimap('minimap-floating');

    fetchGlobal();

    // codeword visibility restore
    setCodewordVisible(storageLoad(STORAGE_KEYS.codewordVisible, '0') === '1');

    // Delegated events
    DOM.grid.addEventListener('click', (e) => {
      const tileEl = e.target.closest('.tile');
      if (!tileEl || tileEl.classList.contains('no-data')) return;
      openTileModalByIndex(parseInt(tileEl.dataset.tileIndex, 10), tileEl);
    });

    DOM.grid.addEventListener('keydown', (e) => {
      const tileEl = e.target.closest('.tile');
      if (!tileEl) return;

      // Enter/Space open
      if ((e.key === 'Enter' || e.key === ' ') && !tileEl.classList.contains('no-data')) {
        e.preventDefault();
        openTileModalByIndex(parseInt(tileEl.dataset.tileIndex, 10), tileEl);
        return;
      }

      // Arrow navigation (7x7)
      const idx = parseInt(tileEl.dataset.tileIndex, 10);
      if (Number.isNaN(idx)) return;

      const move = (d) => {
        const next = idx + d;
        if (next < 0 || next >= MAX_TILES) return;
        DOM.grid.querySelector(`.tile[data-tile-index="${next}"]`)?.focus();
      };

      if (e.key === 'ArrowRight') { e.preventDefault(); move(+1); }
      if (e.key === 'ArrowLeft')  { e.preventDefault(); move(-1); }
      if (e.key === 'ArrowDown')  { e.preventDefault(); move(+7); }
      if (e.key === 'ArrowUp')    { e.preventDefault(); move(-7); }
    });

    DOM.codeword.addEventListener('click', toggleCodeword);
    DOM.codeword.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); toggleCodeword(); }
    });

    // minimap opens overview
    const wireMapOpen = (el) => {
      el.addEventListener('click', () => openMapModal(el));
      el.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); openMapModal(el); }
      });
    };
    wireMapOpen(DOM.miniDash);
    wireMapOpen(DOM.miniFloat);

    // map tile click open tile
    DOM.bigMap.addEventListener('click', (e) => {
      const cell = e.target.closest('.large-map-tile');
      if (!cell) return;
      const id = parseInt(cell.dataset.index, 10);
      if (!id) return;
      openTileModalByIndex(id - 1, cell);
    });
    DOM.bigMap.addEventListener('keydown', (e) => {
      if (e.key !== 'Enter' && e.key !== ' ') return;
      const cell = e.target.closest('.large-map-tile');
      if (!cell) return;
      e.preventDefault();
      const id = parseInt(cell.dataset.index, 10);
      if (!id) return;
      openTileModalByIndex(id - 1, cell);
    });

    // settings
    DOM.settingsTrigger.addEventListener('click', () => openSettingsModal(DOM.settingsTrigger));
    DOM.themeSel.addEventListener('change', () => {
      const v = DOM.themeSel.value;
      applyTheme(v);
      storageSave(STORAGE_KEYS.theme, v);
    });
    DOM.intervalSel.addEventListener('change', () => {
      syncMs = parseInt(DOM.intervalSel.value, 10) || 30000;
      storageSave(STORAGE_KEYS.syncInterval, syncMs);
      restartInterval();
    });

    // modal close
    DOM.overlay.addEventListener('click', (e) => { if (e.target === DOM.overlay) closeModal(); });
    document.querySelectorAll('.modal-close-btn').forEach(btn => btn.addEventListener('click', closeModal));
    DOM.mapBack.addEventListener('click', () => {
      if (ghostEl?.isConnected) ghostEl.classList.remove('ghost');
      ghostEl = null;
      hideViews(); DOM.viewMap.style.display = 'flex';
      buildBigMap();
    });

    // sync now
    DOM.syncNow.addEventListener('click', () => fetchData(true));
    DOM.syncNow.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); fetchData(true); }
    });

    // modal key handling
    document.addEventListener('keydown', (e) => {
      if (modalOpen && e.key === 'Escape') closeModal();
      trapFocus(e);
    });

    // pause syncing when hidden
    document.addEventListener('visibilitychange', () => {
      if (document.hidden) {
        if (syncIntervalId) clearInterval(syncIntervalId);
        syncIntervalId = null;
      } else {
        restartInterval();
        fetchData(false);
      }
    });

    fetchData(false);
    restartInterval();
  }

  init();
})();
</script>